# Fiscally MVP - Component Architecture
## Frontend & Backend Structure (Industry Standard)

---

# PART 1: FRONTEND ARCHITECTURE (React + Vite)

## Project Structure

```
fiscally-frontend/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â”œâ”€â”€ logo.svg
â”‚   â””â”€â”€ mock-data/
â”‚       â”œâ”€â”€ transactions.json
â”‚       â”œâ”€â”€ subscriptions.json
â”‚       â””â”€â”€ vendor-responses.json
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.jsx                      # App entry point
â”‚   â”œâ”€â”€ App.jsx                       # Root component with routing
â”‚   â”‚
â”‚   â”œâ”€â”€ assets/                       # Static assets
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ hero-illustration.svg
â”‚   â”‚   â”‚   â”œâ”€â”€ feature-icons/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ subzero-icon.svg
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dopamine-icon.svg
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ thesisflow-icon.svg
â”‚   â”‚   â”‚   â””â”€â”€ mock-screenshots/
â”‚   â”‚   â”‚       â”œâ”€â”€ adobe-refund-confirmation.png
â”‚   â”‚   â”‚       â””â”€â”€ vendor-chat-screenshot.png
â”‚   â”‚   â””â”€â”€ fonts/
â”‚   â”‚
â”‚   â”œâ”€â”€ components/                   # Reusable UI components
â”‚   â”‚   â”œâ”€â”€ common/                   # Shared components
â”‚   â”‚   â”‚   â”œâ”€â”€ Button/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Button.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Button.test.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Input/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Input.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Card/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Card.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Modal/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Modal.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Spinner/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Spinner.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Badge/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Badge.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Alert/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Alert.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â””â”€â”€ ProgressBar/
â”‚   â”‚   â”‚       â”œâ”€â”€ ProgressBar.jsx
â”‚   â”‚   â”‚       â””â”€â”€ index.js
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ layout/                   # Layout components
â”‚   â”‚   â”‚   â”œâ”€â”€ Navbar/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Navbar.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SidebarItem.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ Footer/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Footer.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â””â”€â”€ DashboardLayout/
â”‚   â”‚   â”‚       â”œâ”€â”€ DashboardLayout.jsx
â”‚   â”‚   â”‚       â””â”€â”€ index.js
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ profile/                  # Profile-specific components
â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileForm/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileForm.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileFormFields.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ RiskToleranceSlider/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RiskToleranceSlider.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â””â”€â”€ ProfileSummaryCard/
â”‚   â”‚   â”‚       â”œâ”€â”€ ProfileSummaryCard.jsx
â”‚   â”‚   â”‚       â””â”€â”€ index.js
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ subzero/                  # SubZero feature components
â”‚   â”‚   â”‚   â”œâ”€â”€ NegotiationForm/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ NegotiationForm.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MerchantSelector.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ NegotiationChat/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ NegotiationChat.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ChatMessage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ChatTypingIndicator.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ SubscriptionList/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SubscriptionList.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SubscriptionCard.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ NegotiationStatus/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ NegotiationStatus.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StatusBadge.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â””â”€â”€ UserDecisionModal/
â”‚   â”‚   â”‚       â”œâ”€â”€ UserDecisionModal.jsx
â”‚   â”‚   â”‚       â””â”€â”€ index.js
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ dopamine-audit/           # DopamineAudit components
â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionList/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionList.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionItem.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionFilters.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ EmotionalTagModal/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmotionalTagModal.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StressLevelSlider.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmotionSelector.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ SpendingPatternChart/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SpendingPatternChart.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StressVsSpendingChart.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TimeOfDayChart.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ RegretReport/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RegretReport.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InsightCard.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RecommendationCard.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ PurchaseInterventionModal/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PurchaseInterventionModal.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â””â”€â”€ SpendingInsights/
â”‚   â”‚   â”‚       â”œâ”€â”€ SpendingInsights.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ TriggerAnalysis.jsx
â”‚   â”‚   â”‚       â””â”€â”€ index.js
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ thesis-flow/              # ThesisFlow components
â”‚   â”‚   â”‚   â”œâ”€â”€ InvestmentQueryInput/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvestmentQueryInput.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SampleQueries.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ ResearchProgress/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ResearchProgress.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ResearchStep.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ InvestmentMemo/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvestmentMemo.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExecutiveSummary.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AssetOverview.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RiskAnalysis.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileAlignment.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ScenarioAnalysis.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SourcesCited.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ RecommendationBadge/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RecommendationBadge.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ RiskRadarChart/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RiskRadarChart.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â”œâ”€â”€ AlternativeSuggestions/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AlternativeSuggestions.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AlternativeCard.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”‚   â””â”€â”€ QueryHistory/
â”‚   â”‚   â”‚       â”œâ”€â”€ QueryHistory.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ QueryHistoryItem.jsx
â”‚   â”‚   â”‚       â””â”€â”€ index.js
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ opik-dashboard/           # Opik integration components
â”‚   â”‚       â”œâ”€â”€ OpikDashboard/
â”‚   â”‚       â”‚   â”œâ”€â”€ OpikDashboard.jsx
â”‚   â”‚       â”‚   â””â”€â”€ index.js
â”‚   â”‚       â”œâ”€â”€ MetricCard/
â”‚   â”‚       â”‚   â”œâ”€â”€ MetricCard.jsx
â”‚   â”‚       â”‚   â””â”€â”€ index.js
â”‚   â”‚       â”œâ”€â”€ TraceViewer/
â”‚   â”‚       â”‚   â”œâ”€â”€ TraceViewer.jsx
â”‚   â”‚       â”‚   â”œâ”€â”€ TraceItem.jsx
â”‚   â”‚       â”‚   â””â”€â”€ index.js
â”‚   â”‚       â””â”€â”€ EvaluationResults/
â”‚   â”‚           â”œâ”€â”€ EvaluationResults.jsx
â”‚   â”‚           â”œâ”€â”€ ScoreGauge.jsx
â”‚   â”‚           â””â”€â”€ index.js
â”‚   â”‚
â”‚   â”œâ”€â”€ pages/                        # Page-level components (routes)
â”‚   â”‚   â”œâ”€â”€ LandingPage/
â”‚   â”‚   â”‚   â”œâ”€â”€ LandingPage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ HeroSection.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ FeaturesSection.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ HowItWorksSection.jsx
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ OnboardingPage/
â”‚   â”‚   â”‚   â”œâ”€â”€ OnboardingPage.jsx
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ DashboardPage/
â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardPage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardOverview.jsx
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ SubZeroPage/
â”‚   â”‚   â”‚   â”œâ”€â”€ SubZeroPage.jsx
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ DopamineAuditPage/
â”‚   â”‚   â”‚   â”œâ”€â”€ DopamineAuditPage.jsx
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ ThesisFlowPage/
â”‚   â”‚   â”‚   â”œâ”€â”€ ThesisFlowPage.jsx
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â”œâ”€â”€ OpikPage/
â”‚   â”‚   â”‚   â”œâ”€â”€ OpikPage.jsx
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â””â”€â”€ NotFoundPage/
â”‚   â”‚       â”œâ”€â”€ NotFoundPage.jsx
â”‚   â”‚       â””â”€â”€ index.js
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                        # Custom React hooks
â”‚   â”‚   â”œâ”€â”€ useLocalStorage.js
â”‚   â”‚   â”œâ”€â”€ useProfile.js
â”‚   â”‚   â”œâ”€â”€ useNegotiation.js
â”‚   â”‚   â”œâ”€â”€ useTransactions.js
â”‚   â”‚   â”œâ”€â”€ useInvestmentQuery.js
â”‚   â”‚   â”œâ”€â”€ useWebSocket.js
â”‚   â”‚   â””â”€â”€ useDebounce.js
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                     # API service layer
â”‚   â”‚   â”œâ”€â”€ api.js                    # Axios instance configuration
â”‚   â”‚   â”œâ”€â”€ profileService.js
â”‚   â”‚   â”œâ”€â”€ subzeroService.js
â”‚   â”‚   â”œâ”€â”€ dopamineAuditService.js
â”‚   â”‚   â”œâ”€â”€ thesisFlowService.js
â”‚   â”‚   â””â”€â”€ opikService.js
â”‚   â”‚
â”‚   â”œâ”€â”€ store/                        # State management (Context API or Zustand)
â”‚   â”‚   â”œâ”€â”€ ProfileContext.jsx
â”‚   â”‚   â”œâ”€â”€ NegotiationContext.jsx
â”‚   â”‚   â”œâ”€â”€ TransactionContext.jsx
â”‚   â”‚   â””â”€â”€ AppContext.jsx
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                        # Utility functions
â”‚   â”‚   â”œâ”€â”€ formatters.js             # Date, currency formatters
â”‚   â”‚   â”œâ”€â”€ validators.js             # Form validation
â”‚   â”‚   â”œâ”€â”€ constants.js              # App-wide constants
â”‚   â”‚   â”œâ”€â”€ mockData.js               # Mock data generators
â”‚   â”‚   â””â”€â”€ helpers.js                # General helper functions
â”‚   â”‚
â”‚   â”œâ”€â”€ styles/                       # Global styles
â”‚   â”‚   â”œâ”€â”€ index.css                 # Tailwind imports + global styles
â”‚   â”‚   â””â”€â”€ variables.css             # CSS custom properties
â”‚   â”‚
â”‚   â””â”€â”€ config/                       # Configuration files
â”‚       â”œâ”€â”€ routes.js                 # Route definitions
â”‚       â””â”€â”€ env.js                    # Environment variables
â”‚
â”œâ”€â”€ .env.example                      # Environment variables template
â”œâ”€â”€ .env.local                        # Local environment (gitignored)
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package.json
â”œâ”€â”€ vite.config.js
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ eslint.config.js
â””â”€â”€ README.md
```

---

## Frontend Component Examples

### 1. App.jsx (Root Component)
```javascript
// src/App.jsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { AppProvider } from './store/AppContext';

// Pages
import LandingPage from './pages/LandingPage';
import OnboardingPage from './pages/OnboardingPage';
import DashboardPage from './pages/DashboardPage';
import SubZeroPage from './pages/SubZeroPage';
import DopamineAuditPage from './pages/DopamineAuditPage';
import ThesisFlowPage from './pages/ThesisFlowPage';
import OpikPage from './pages/OpikPage';
import NotFoundPage from './pages/NotFoundPage';

// Layout
import DashboardLayout from './components/layout/DashboardLayout';

function App() {
  return (
    <AppProvider>
      <BrowserRouter>
        <Routes>
          {/* Public Routes */}
          <Route path="/" element={<LandingPage />} />
          <Route path="/onboarding" element={<OnboardingPage />} />
          
          {/* Dashboard Routes */}
          <Route element={<DashboardLayout />}>
            <Route path="/dashboard" element={<DashboardPage />} />
            <Route path="/subzero" element={<SubZeroPage />} />
            <Route path="/dopamine-audit" element={<DopamineAuditPage />} />
            <Route path="/thesis-flow" element={<ThesisFlowPage />} />
            <Route path="/opik" element={<OpikPage />} />
          </Route>
          
          {/* 404 */}
          <Route path="*" element={<NotFoundPage />} />
        </Routes>
      </BrowserRouter>
    </AppProvider>
  );
}

export default App;
```

### 2. Service Layer Example
```javascript
// src/services/api.js
import axios from 'axios';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000/api/v1';

const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Request interceptor
apiClient.interceptors.request.use(
  (config) => {
    // Add any auth tokens here if needed
    return config;
  },
  (error) => Promise.reject(error)
);

// Response interceptor
apiClient.interceptors.response.use(
  (response) => response.data,
  (error) => {
    console.error('API Error:', error);
    return Promise.reject(error);
  }
);

export default apiClient;
```

```javascript
// src/services/subzeroService.js
import apiClient from './api';

export const subzeroService = {
  // Start a new negotiation
  startNegotiation: async (negotiationData) => {
    return apiClient.post('/subzero/negotiations', negotiationData);
  },
  
  // Get negotiation status
  getNegotiationStatus: async (negotiationId) => {
    return apiClient.get(`/subzero/negotiations/${negotiationId}`);
  },
  
  // Send user decision (accept/reject vendor offer)
  submitUserDecision: async (negotiationId, decision) => {
    return apiClient.post(`/subzero/negotiations/${negotiationId}/decision`, { decision });
  },
  
  // Get all subscriptions
  getSubscriptions: async () => {
    return apiClient.get('/subzero/subscriptions');
  },
  
  // Get negotiation history
  getNegotiationHistory: async () => {
    return apiClient.get('/subzero/negotiations/history');
  },
};
```

### 3. Custom Hook Example
```javascript
// src/hooks/useNegotiation.js
import { useState, useEffect } from 'react';
import { subzeroService } from '../services/subzeroService';

export const useNegotiation = (negotiationId) => {
  const [negotiation, setNegotiation] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const startNegotiation = async (data) => {
    setLoading(true);
    setError(null);
    try {
      const result = await subzeroService.startNegotiation(data);
      setNegotiation(result);
      return result;
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  };

  const submitDecision = async (decision) => {
    setLoading(true);
    try {
      const result = await subzeroService.submitUserDecision(negotiationId, decision);
      setNegotiation(result);
      return result;
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (negotiationId) {
      const fetchNegotiation = async () => {
        setLoading(true);
        try {
          const result = await subzeroService.getNegotiationStatus(negotiationId);
          setNegotiation(result);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };
      fetchNegotiation();
    }
  }, [negotiationId]);

  return {
    negotiation,
    loading,
    error,
    startNegotiation,
    submitDecision,
  };
};
```

---

# PART 2: BACKEND ARCHITECTURE (FastAPI + Python)

## Project Structure

```
fiscally-backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                       # FastAPI application entry point
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                          # API layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ deps.py                   # Dependency injection
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ v1/                       # API version 1
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ router.py             # Main API router
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€â”€ endpoints/            # API endpoints by feature
â”‚   â”‚           â”œâ”€â”€ __init__.py
â”‚   â”‚           â”œâ”€â”€ profile.py
â”‚   â”‚           â”œâ”€â”€ subzero.py
â”‚   â”‚           â”œâ”€â”€ dopamine_audit.py
â”‚   â”‚           â”œâ”€â”€ thesis_flow.py
â”‚   â”‚           â”œâ”€â”€ opik.py
â”‚   â”‚           â””â”€â”€ health.py
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                         # Core application code
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py                 # Configuration (Pydantic Settings)
â”‚   â”‚   â”œâ”€â”€ security.py               # Security utilities (future)
â”‚   â”‚   â”œâ”€â”€ logging.py                # Logging configuration
â”‚   â”‚   â””â”€â”€ exceptions.py             # Custom exceptions
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                       # Pydantic models (schemas)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ profile.py                # User profile schemas
â”‚   â”‚   â”œâ”€â”€ subzero.py                # SubZero schemas
â”‚   â”‚   â”œâ”€â”€ dopamine_audit.py         # DopamineAudit schemas
â”‚   â”‚   â”œâ”€â”€ thesis_flow.py            # ThesisFlow schemas
â”‚   â”‚   â””â”€â”€ common.py                 # Shared schemas
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                     # Business logic layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ profile_service.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ subzero/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ negotiation_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ subscription_service.py
â”‚   â”‚   â”‚   â””â”€â”€ vendor_communication_service.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ dopamine_audit/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ transaction_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ emotion_analysis_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ pattern_detection_service.py
â”‚   â”‚   â”‚   â””â”€â”€ intervention_service.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ thesis_flow/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ research_service.py
â”‚   â”‚       â”œâ”€â”€ risk_analysis_service.py
â”‚   â”‚       â”œâ”€â”€ memo_generation_service.py
â”‚   â”‚       â””â”€â”€ source_validation_service.py
â”‚   â”‚
â”‚   â”œâ”€â”€ agents/                       # LangGraph agent implementations
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ subzero/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ negotiation_agent.py
â”‚   â”‚   â”‚   â”œâ”€â”€ states.py             # Agent state definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ nodes.py              # Agent node functions
â”‚   â”‚   â”‚   â””â”€â”€ graph.py              # LangGraph graph definition
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ dopamine_audit/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ analysis_agent.py
â”‚   â”‚   â”‚   â”œâ”€â”€ states.py
â”‚   â”‚   â”‚   â”œâ”€â”€ nodes.py
â”‚   â”‚   â”‚   â””â”€â”€ graph.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ thesis_flow/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ research_agent.py
â”‚   â”‚       â”œâ”€â”€ states.py
â”‚   â”‚       â”œâ”€â”€ nodes.py
â”‚   â”‚       â””â”€â”€ graph.py
â”‚   â”‚
â”‚   â”œâ”€â”€ integrations/                 # External API integrations
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ openai_client.py
â”‚   â”‚   â”œâ”€â”€ tavily_client.py
â”‚   â”‚   â”œâ”€â”€ opik_client.py
â”‚   â”‚   â””â”€â”€ mock/                     # Mock integrations for demo
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ mock_plaid.py
â”‚   â”‚       â””â”€â”€ mock_vendor_api.py
â”‚   â”‚
â”‚   â”œâ”€â”€ repositories/                 # Data access layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base_repository.py
â”‚   â”‚   â”œâ”€â”€ profile_repository.py
â”‚   â”‚   â”œâ”€â”€ negotiation_repository.py
â”‚   â”‚   â”œâ”€â”€ transaction_repository.py
â”‚   â”‚   â””â”€â”€ investment_query_repository.py
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                           # Database layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                   # SQLite/JSON base setup
â”‚   â”‚   â””â”€â”€ session.py                # Database session management
â”‚   â”‚
â”‚   â”œâ”€â”€ evaluation/                   # Opik evaluation logic
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ metrics/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ negotiation_metrics.py
â”‚   â”‚   â”‚   â”œâ”€â”€ empathy_metrics.py
â”‚   â”‚   â”‚   â””â”€â”€ fiduciary_metrics.py
â”‚   â”‚   â”œâ”€â”€ datasets/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ negotiation_scenarios.py
â”‚   â”‚   â”‚   â”œâ”€â”€ emotional_responses.py
â”‚   â”‚   â”‚   â””â”€â”€ investment_queries.py
â”‚   â”‚   â””â”€â”€ evaluator.py              # Main evaluation orchestrator
â”‚   â”‚
â”‚   â””â”€â”€ utils/                        # Utility functions
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ formatters.py
â”‚       â”œâ”€â”€ validators.py
â”‚       â”œâ”€â”€ constants.py
â”‚       â””â”€â”€ helpers.py
â”‚
â”œâ”€â”€ data/                             # Data storage (for MVP)
â”‚   â”œâ”€â”€ profiles/                     # User profiles (JSON files)
â”‚   â”œâ”€â”€ negotiations/                 # Negotiation cases
â”‚   â”œâ”€â”€ transactions/                 # Mock transactions
â”‚   â””â”€â”€ queries/                      # Investment queries
â”‚
â”œâ”€â”€ mock_data/                        # Mock data for demos
â”‚   â”œâ”€â”€ sample_transactions.json
â”‚   â”œâ”€â”€ vendor_policies.json
â”‚   â”œâ”€â”€ vendor_responses.json
â”‚   â””â”€â”€ market_data.json
â”‚
â”œâ”€â”€ tests/                            # Tests (optional for MVP)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_api/
â”‚   â”œâ”€â”€ test_services/
â”‚   â””â”€â”€ test_agents/
â”‚
â”œâ”€â”€ .env.example                      # Environment variables template
â”œâ”€â”€ .env                              # Environment variables (gitignored)
â”œâ”€â”€ .gitignore
â”œâ”€â”€ requirements.txt                  # Python dependencies
â”œâ”€â”€ pyproject.toml                    # Poetry configuration (alternative)
â”œâ”€â”€ README.md
â””â”€â”€ run.py                            # Entry point script
```

---

## Backend Component Examples

### 1. Main Application Entry Point
```python
# app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager

from app.core.config import settings
from app.core.logging import setup_logging
from app.api.v1.router import api_router

# Setup logging
setup_logging()

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    print("ðŸš€ Fiscally API starting up...")
    # Initialize services, load mock data, etc.
    yield
    # Shutdown
    print("ðŸ‘‹ Fiscally API shutting down...")

# Create FastAPI app
app = FastAPI(
    title="Fiscally API",
    description="AI-Powered Personal Financial Agent API",
    version="1.0.0",
    lifespan=lifespan,
)

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Include API router
app.include_router(api_router, prefix="/api/v1")

@app.get("/")
async def root():
    return {
        "message": "Fiscally API",
        "version": "1.0.0",
        "status": "running"
    }

@app.get("/health")
async def health_check():
    return {"status": "healthy"}
```

### 2. Configuration
```python
# app/core/config.py
from pydantic_settings import BaseSettings
from typing import List

class Settings(BaseSettings):
    # App Settings
    APP_NAME: str = "Fiscally"
    DEBUG: bool = True
    API_V1_PREFIX: str = "/api/v1"
    
    # CORS
    CORS_ORIGINS: List[str] = [
        "http://localhost:5173",
        "http://localhost:3000",
    ]
    
    # OpenAI
    OPENAI_API_KEY: str
    OPENAI_MODEL: str = "gpt-4o"
    
    # Tavily
    TAVILY_API_KEY: str = ""
    
    # Opik
    OPIK_API_KEY: str = ""
    OPIK_WORKSPACE: str = "fiscally-hackathon"
    
    # Database (SQLite for MVP)
    DATABASE_URL: str = "sqlite:///./data/fiscally.db"
    
    # Mock Mode (for demo without real APIs)
    MOCK_MODE: bool = True
    
    class Config:
        env_file = ".env"
        case_sensitive = True

settings = Settings()
```

### 3. API Router
```python
# app/api/v1/router.py
from fastapi import APIRouter

from app.api.v1.endpoints import (
    health,
    profile,
    subzero,
    dopamine_audit,
    thesis_flow,
    opik,
)

api_router = APIRouter()

# Include all endpoint routers
api_router.include_router(health.router, prefix="/health", tags=["Health"])
api_router.include_router(profile.router, prefix="/profile", tags=["Profile"])
api_router.include_router(subzero.router, prefix="/subzero", tags=["SubZero"])
api_router.include_router(dopamine_audit.router, prefix="/dopamine-audit", tags=["DopamineAudit"])
api_router.include_router(thesis_flow.router, prefix="/thesis-flow", tags=["ThesisFlow"])
api_router.include_router(opik.router, prefix="/opik", tags=["Opik"])
```

### 4. Endpoint Example (SubZero)
```python
# app/api/v1/endpoints/subzero.py
from fastapi import APIRouter, HTTPException, BackgroundTasks
from typing import List
from uuid import UUID

from app.models.subzero import (
    NegotiationRequest,
    NegotiationResponse,
    NegotiationStatusResponse,
    UserDecisionRequest,
    SubscriptionResponse,
)
from app.services.subzero.negotiation_service import NegotiationService

router = APIRouter()
negotiation_service = NegotiationService()

@router.post("/negotiations", response_model=NegotiationResponse)
async def start_negotiation(
    request: NegotiationRequest,
    background_tasks: BackgroundTasks
):
    """
    Start a new subscription negotiation.
    """
    try:
        negotiation = await negotiation_service.start_negotiation(request)
        
        # Run negotiation in background
        background_tasks.add_task(
            negotiation_service.run_negotiation_flow,
            negotiation.id
        )
        
        return negotiation
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/negotiations/{negotiation_id}", response_model=NegotiationStatusResponse)
async def get_negotiation_status(negotiation_id: UUID):
    """
    Get the current status of a negotiation.
    """
    negotiation = await negotiation_service.get_negotiation(negotiation_id)
    if not negotiation:
        raise HTTPException(status_code=404, detail="Negotiation not found")
    return negotiation

@router.post("/negotiations/{negotiation_id}/decision")
async def submit_user_decision(
    negotiation_id: UUID,
    decision: UserDecisionRequest,
    background_tasks: BackgroundTasks
):
    """
    Submit user's decision on a vendor offer.
    """
    try:
        result = await negotiation_service.handle_user_decision(
            negotiation_id,
            decision.choice
        )
        
        # Continue negotiation if needed
        if result.status == "in_progress":
            background_tasks.add_task(
                negotiation_service.continue_negotiation,
                negotiation_id
            )
        
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/subscriptions", response_model=List[SubscriptionResponse])
async def get_subscriptions():
    """
    Get all user subscriptions.
    """
    return await negotiation_service.get_all_subscriptions()

@router.get("/negotiations/history", response_model=List[NegotiationResponse])
async def get_negotiation_history():
    """
    Get all past negotiations.
    """
    return await negotiation_service.get_negotiation_history()
```

### 5. Pydantic Models (Schemas)
```python
# app/models/subzero.py
from pydantic import BaseModel, Field
from typing import Optional, List, Literal
from datetime import datetime
from uuid import UUID, uuid4

class NegotiationRequest(BaseModel):
    merchant_name: str = Field(..., example="Adobe")
    amount: float = Field(..., example=54.99)
    goal: Literal["full_refund", "partial_refund", "better_deal", "cancel_only"] = Field(
        ..., 
        example="full_refund"
    )
    user_note: Optional[str] = Field(None, example="Forgot to cancel free trial")

class NegotiationMessage(BaseModel):
    role: Literal["agent", "vendor", "system"]
    content: str
    timestamp: datetime = Field(default_factory=datetime.utcnow)

class NegotiationResponse(BaseModel):
    id: UUID = Field(default_factory=uuid4)
    merchant_name: str
    amount: float
    goal: str
    status: Literal["pending", "in_progress", "awaiting_user", "success", "failed"]
    messages: List[NegotiationMessage] = []
    outcome: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)

class NegotiationStatusResponse(NegotiationResponse):
    vendor_offer: Optional[str] = None
    requires_user_decision: bool = False

class UserDecisionRequest(BaseModel):
    choice: Literal["accept", "reject", "counter"]
    note: Optional[str] = None

class SubscriptionResponse(BaseModel):
    id: UUID
    merchant_name: str
    amount: float
    billing_frequency: str
    next_billing_date: datetime
    status: str
```

### 6. Service Layer (Business Logic)
```python
# app/services/subzero/negotiation_service.py
import asyncio
from uuid import UUID
from typing import List, Optional

from app.models.subzero import NegotiationRequest, NegotiationResponse
from app.agents.subzero.negotiation_agent import NegotiationAgent
from app.repositories.negotiation_repository import NegotiationRepository
from app.integrations.opik_client import opik_client

class NegotiationService:
    def __init__(self):
        self.repository = NegotiationRepository()
        self.agent = NegotiationAgent()
    
    async def start_negotiation(self, request: NegotiationRequest) -> NegotiationResponse:
        """
        Initialize a new negotiation case.
        """
        # Create negotiation record
        negotiation = NegotiationResponse(
            merchant_name=request.merchant_name,
            amount=request.amount,
            goal=request.goal,
            status="pending",
        )
        
        # Save to repository
        await self.repository.create(negotiation)
        
        return negotiation
    
    async def run_negotiation_flow(self, negotiation_id: UUID):
        """
        Execute the negotiation agent workflow.
        """
        # Get negotiation
        negotiation = await self.repository.get(negotiation_id)
        
        # Update status
        negotiation.status = "in_progress"
        await self.repository.update(negotiation)
        
        # Run agent with Opik tracing
        with opik_client.trace(
            name="subzero_negotiation",
            input={
                "merchant": negotiation.merchant_name,
                "amount": negotiation.amount,
                "goal": negotiation.goal
            }
        ):
            result = await self.agent.negotiate(negotiation)
        
        # Update negotiation with result
        negotiation.status = result.status
        negotiation.messages = result.messages
        negotiation.outcome = result.outcome
        await self.repository.update(negotiation)
        
        return negotiation
    
    async def get_negotiation(self, negotiation_id: UUID) -> Optional[NegotiationResponse]:
        """
        Retrieve negotiation by ID.
        """
        return await self.repository.get(negotiation_id)
    
    async def handle_user_decision(self, negotiation_id: UUID, choice: str):
        """
        Process user's decision on vendor offer.
        """
        negotiation = await self.repository.get(negotiation_id)
        
        # Agent continues based on user choice
        result = await self.agent.process_user_decision(negotiation, choice)
        
        # Update negotiation
        negotiation.status = result.status
        negotiation.messages.extend(result.new_messages)
        await self.repository.update(negotiation)
        
        return negotiation
    
    async def continue_negotiation(self, negotiation_id: UUID):
        """
        Continue negotiation after user decision.
        """
        negotiation = await self.repository.get(negotiation_id)
        result = await self.agent.continue_flow(negotiation)
        
        negotiation.status = result.status
        negotiation.outcome = result.outcome
        await self.repository.update(negotiation)
    
    async def get_all_subscriptions(self) -> List:
        """
        Get all subscriptions (mock data for MVP).
        """
        return await self.repository.get_all_subscriptions()
    
    async def get_negotiation_history(self) -> List[NegotiationResponse]:
        """
        Get all past negotiations.
        """
        return await self.repository.get_all_negotiations()
```

### 7. LangGraph Agent Implementation
```python
# app/agents/subzero/states.py
from typing import List, Optional, Literal
from pydantic import BaseModel

class NegotiationState(BaseModel):
    """
    State for the negotiation agent workflow.
    """
    merchant_name: str
    amount: float
    user_goal: str
    
    # Agent state
    current_step: Literal[
        "analyze_policy",
        "draft_message",
        "send_to_vendor",
        "process_response",
        "evaluate_offer",
        "await_user_decision",
        "finalize"
    ] = "analyze_policy"
    
    # Data
    vendor_policy: Optional[str] = None
    messages: List[dict] = []
    vendor_current_offer: Optional[str] = None
    user_decision: Optional[str] = None
    
    # Outcome
    final_status: Optional[str] = None
    final_outcome: Optional[str] = None
    
    # Opik tracking
    tenacity_score: int = 0  # How many bad offers rejected
    iterations: int = 0
```

```python
# app/agents/subzero/nodes.py
from langchain_openai import ChatOpenAI
from app.core.config import settings
from app.integrations.mock.mock_vendor_api import MockVendorAPI

llm = ChatOpenAI(
    model=settings.OPENAI_MODEL,
    api_key=settings.OPENAI_API_KEY
)
mock_vendor = MockVendorAPI()

async def analyze_policy_node(state: NegotiationState) -> dict:
    """
    Analyze vendor's refund/cancellation policy.
    """
    # In MVP, retrieve from mock database
    policy = await mock_vendor.get_refund_policy(state.merchant_name)
    
    return {
        "vendor_policy": policy,
        "current_step": "draft_message"
    }

async def draft_message_node(state: NegotiationState) -> dict:
    """
    Agent drafts opening message to vendor.
    """
    prompt = f"""
    You are a negotiation agent helping a user get a refund from {state.merchant_name}.
    
    User's goal: {state.user_goal}
    Amount: ${state.amount}
    Vendor policy: {state.vendor_policy}
    
    Draft a polite but firm opening message requesting the user's goal.
    Keep it under 100 words.
    """
    
    response = await llm.ainvoke(prompt)
    agent_message = response.content
    
    return {
        "messages": state.messages + [{
            "role": "agent",
            "content": agent_message
        }],
        "current_step": "send_to_vendor"
    }

async def send_to_vendor_node(state: NegotiationState) -> dict:
    """
    Simulate sending message to vendor and receiving response.
    """
    # In MVP, use mock vendor API
    vendor_response = await mock_vendor.get_response(
        merchant=state.merchant_name,
        user_goal=state.user_goal,
        iteration=state.iterations
    )
    
    return {
        "messages": state.messages + [{
            "role": "vendor",
            "content": vendor_response["message"]
        }],
        "vendor_current_offer": vendor_response.get("offer"),
        "current_step": "evaluate_offer"
    }

async def evaluate_offer_node(state: NegotiationState) -> dict:
    """
    Agent evaluates vendor's offer against user's goal.
    """
    prompt = f"""
    User wanted: {state.user_goal}
    Vendor offered: {state.vendor_current_offer}
    
    Is this offer acceptable? Answer with:
    - "ACCEPT" if it matches the user's goal
    - "REJECT_AND_COUNTER" if it's a bad retention offer
    - "ASK_USER" if it's a reasonable alternative
    
    Explain your reasoning briefly.
    """
    
    response = await llm.ainvoke(prompt)
    decision = response.content
    
    # Track tenacity (rejecting bad offers)
    tenacity_score = state.tenacity_score
    if "REJECT_AND_COUNTER" in decision:
        tenacity_score += 1
    
    if "ACCEPT" in decision:
        next_step = "finalize"
    elif "ASK_USER" in decision:
        next_step = "await_user_decision"
    else:
        next_step = "draft_message"  # Counter-offer
    
    return {
        "current_step": next_step,
        "tenacity_score": tenacity_score,
        "iterations": state.iterations + 1
    }

async def await_user_decision_node(state: NegotiationState) -> dict:
    """
    Pause and wait for user's decision.
    """
    # This node doesn't transition automatically
    # It waits for external input (user decision via API)
    return {"current_step": "await_user_decision"}

async def finalize_node(state: NegotiationState) -> dict:
    """
    Finalize negotiation with outcome.
    """
    # Determine final status
    if state.user_goal in str(state.vendor_current_offer).lower():
        final_status = "success"
        final_outcome = f"Achieved goal: {state.vendor_current_offer}"
    else:
        final_status = "success"
        final_outcome = f"Reached agreement: {state.vendor_current_offer}"
    
    return {
        "final_status": final_status,
        "final_outcome": final_outcome,
        "current_step": "finalize"
    }
```

```python
# app/agents/subzero/graph.py
from langgraph.graph import StateGraph, END
from app.agents.subzero.states import NegotiationState
from app.agents.subzero import nodes

def create_negotiation_graph():
    """
    Create the LangGraph workflow for negotiation.
    """
    workflow = StateGraph(NegotiationState)
    
    # Add nodes
    workflow.add_node("analyze_policy", nodes.analyze_policy_node)
    workflow.add_node("draft_message", nodes.draft_message_node)
    workflow.add_node("send_to_vendor", nodes.send_to_vendor_node)
    workflow.add_node("evaluate_offer", nodes.evaluate_offer_node)
    workflow.add_node("await_user", nodes.await_user_decision_node)
    workflow.add_node("finalize", nodes.finalize_node)
    
    # Define edges
    workflow.add_edge("analyze_policy", "draft_message")
    workflow.add_edge("draft_message", "send_to_vendor")
    workflow.add_edge("send_to_vendor", "evaluate_offer")
    
    # Conditional edges from evaluate_offer
    workflow.add_conditional_edges(
        "evaluate_offer",
        lambda state: state.current_step,
        {
            "draft_message": "draft_message",
            "await_user_decision": "await_user",
            "finalize": "finalize"
        }
    )
    
    workflow.add_edge("finalize", END)
    
    # Set entry point
    workflow.set_entry_point("analyze_policy")
    
    return workflow.compile()
```

```python
# app/agents/subzero/negotiation_agent.py
from app.agents.subzero.graph import create_negotiation_graph
from app.agents.subzero.states import NegotiationState

class NegotiationAgent:
    def __init__(self):
        self.graph = create_negotiation_graph()
    
    async def negotiate(self, negotiation):
        """
        Run the negotiation workflow.
        """
        # Initialize state
        initial_state = NegotiationState(
            merchant_name=negotiation.merchant_name,
            amount=negotiation.amount,
            user_goal=negotiation.goal
        )
        
        # Run graph until it reaches await_user or finalize
        result = await self.graph.ainvoke(initial_state)
        
        return result
    
    async def process_user_decision(self, negotiation, choice):
        """
        Handle user's decision and continue workflow.
        """
        # Resume from current state
        # (Implementation details depend on state persistence)
        pass
    
    async def continue_flow(self, negotiation):
        """
        Continue negotiation after user decision.
        """
        pass
```

### 8. Repository Pattern
```python
# app/repositories/negotiation_repository.py
import json
from pathlib import Path
from typing import List, Optional
from uuid import UUID

from app.models.subzero import NegotiationResponse

DATA_DIR = Path("data/negotiations")
DATA_DIR.mkdir(parents=True, exist_ok=True)

class NegotiationRepository:
    """
    Simple file-based repository for MVP.
    In production, this would use a real database.
    """
    
    async def create(self, negotiation: NegotiationResponse) -> NegotiationResponse:
        """
        Save a new negotiation.
        """
        file_path = DATA_DIR / f"{negotiation.id}.json"
        with open(file_path, 'w') as f:
            json.dump(negotiation.model_dump(mode='json'), f, indent=2, default=str)
        return negotiation
    
    async def get(self, negotiation_id: UUID) -> Optional[NegotiationResponse]:
        """
        Retrieve negotiation by ID.
        """
        file_path = DATA_DIR / f"{negotiation_id}.json"
        if not file_path.exists():
            return None
        
        with open(file_path, 'r') as f:
            data = json.load(f)
        return NegotiationResponse(**data)
    
    async def update(self, negotiation: NegotiationResponse) -> NegotiationResponse:
        """
        Update existing negotiation.
        """
        return await self.create(negotiation)  # Overwrite
    
    async def get_all_negotiations(self) -> List[NegotiationResponse]:
        """
        Get all negotiations.
        """
        negotiations = []
        for file_path in DATA_DIR.glob("*.json"):
            with open(file_path, 'r') as f:
                data = json.load(f)
            negotiations.append(NegotiationResponse(**data))
        return negotiations
    
    async def get_all_subscriptions(self) -> List:
        """
        Get mock subscriptions.
        """
        # Return mock data
        return [
            {
                "id": "sub_1",
                "merchant_name": "Adobe Creative Cloud",
                "amount": 54.99,
                "billing_frequency": "monthly",
                "next_billing_date": "2026-02-15",
                "status": "active"
            },
            {
                "id": "sub_2",
                "merchant_name": "Netflix",
                "amount": 15.99,
                "billing_frequency": "monthly",
                "next_billing_date": "2026-02-10",
                "status": "active"
            },
        ]
```

### 9. Opik Integration
```python
# app/integrations/opik_client.py
from opik import Opik
from app.core.config import settings

class OpikClient:
    def __init__(self):
        self.client = Opik(
            api_key=settings.OPIK_API_KEY,
            workspace=settings.OPIK_WORKSPACE
        ) if settings.OPIK_API_KEY else None
    
    def trace(self, name: str, input: dict):
        """
        Create a new trace context.
        """
        if self.client:
            return self.client.trace(name=name, input=input)
        else:
            # Mock context for local development
            from contextlib import nullcontext
            return nullcontext()
    
    def log_metric(self, name: str, value: float, metadata: dict = None):
        """
        Log a custom metric.
        """
        if self.client:
            self.client.log_metric(name=name, value=value, metadata=metadata)

opik_client = OpikClient()
```

### 10. Evaluation Framework
```python
# app/evaluation/metrics/negotiation_metrics.py
from typing import List, Dict

def calculate_tenacity_score(negotiation_trace: Dict) -> float:
    """
    Calculate how persistently the agent rejected bad offers.
    
    Score = (Bad offers rejected / Total bad offers received) * 10
    """
    bad_offers_rejected = negotiation_trace.get("tenacity_score", 0)
    total_iterations = negotiation_trace.get("iterations", 1)
    
    # Estimate bad offers (for MVP, use simple heuristic)
    bad_offers_count = max(1, total_iterations - 1)
    
    score = (bad_offers_rejected / bad_offers_count) * 10
    return min(10.0, score)

def calculate_goal_alignment_score(user_goal: str, final_outcome: str) -> float:
    """
    Calculate how well the outcome aligns with user's goal.
    """
    user_goal_lower = user_goal.lower()
    outcome_lower = final_outcome.lower()
    
    if user_goal_lower in outcome_lower:
        return 10.0
    elif "refund" in user_goal_lower and "refund" in outcome_lower:
        return 8.0
    elif "cancel" in user_goal_lower and "cancel" in outcome_lower:
        return 7.0
    else:
        return 5.0
```

```python
# app/evaluation/evaluator.py
from app.evaluation.metrics import negotiation_metrics
from app.integrations.opik_client import opik_client

class Evaluator:
    """
    Main evaluation orchestrator for Opik integration.
    """
    
    def evaluate_negotiation(self, negotiation_data: dict):
        """
        Evaluate a negotiation and log metrics to Opik.
        """
        # Calculate metrics
        tenacity = negotiation_metrics.calculate_tenacity_score(negotiation_data)
        goal_alignment = negotiation_metrics.calculate_goal_alignment_score(
            negotiation_data["user_goal"],
            negotiation_data["final_outcome"]
        )
        
        # Log to Opik
        opik_client.log_metric("negotiation_tenacity_score", tenacity, {
            "negotiation_id": negotiation_data["id"],
            "merchant": negotiation_data["merchant_name"]
        })
        
        opik_client.log_metric("goal_alignment_score", goal_alignment, {
            "negotiation_id": negotiation_data["id"],
            "user_goal": negotiation_data["user_goal"]
        })
        
        return {
            "tenacity_score": tenacity,
            "goal_alignment_score": goal_alignment
        }

evaluator = Evaluator()
```

---

## Environment Setup Files

### requirements.txt
```txt
# FastAPI
fastapi==0.109.0
uvicorn[standard]==0.27.0
pydantic==2.5.3
pydantic-settings==2.1.0

# LangChain & AI
langchain==0.1.6
langchain-openai==0.0.5
langgraph==0.0.20
openai==1.10.0

# Opik
opik==0.1.15

# Web Search
tavily-python==0.3.0

# Database (SQLite for MVP)
aiosqlite==0.19.0
sqlalchemy==2.0.25

# Utilities
python-dotenv==1.0.0
python-multipart==0.0.6
httpx==0.26.0
```

### .env.example
```bash
# App Configuration
DEBUG=true
CORS_ORIGINS=["http://localhost:5173","http://localhost:3000"]

# OpenAI
OPENAI_API_KEY=sk-your-key-here
OPENAI_MODEL=gpt-4o

# Tavily (Web Search)
TAVILY_API_KEY=tvly-your-key-here

# Opik
OPIK_API_KEY=opik-your-key-here
OPIK_WORKSPACE=fiscally-hackathon

# Mock Mode (set to false for real APIs)
MOCK_MODE=true
```

### run.py
```python
# run.py
import uvicorn

if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )
```

---

## File Naming Conventions Summary

### Frontend:
- **Components:** PascalCase (e.g., `Button.jsx`, `NegotiationChat.jsx`)
- **Hooks:** camelCase with `use` prefix (e.g., `useProfile.js`, `useNegotiation.js`)
- **Services:** camelCase with `Service` suffix (e.g., `profileService.js`, `subzeroService.js`)
- **Pages:** PascalCase with `Page` suffix (e.g., `LandingPage.jsx`, `DashboardPage.jsx`)
- **Utils:** camelCase (e.g., `formatters.js`, `validators.js`)

### Backend:
- **Files:** snake_case (e.g., `negotiation_service.py`, `profile_repository.py`)
- **Classes:** PascalCase (e.g., `NegotiationService`, `ProfileRepository`)
- **Functions:** snake_case (e.g., `start_negotiation()`, `calculate_tenacity_score()`)
- **Models:** PascalCase (e.g., `NegotiationRequest`, `UserProfile`)
- **Constants:** UPPER_SNAKE_CASE (e.g., `API_VERSION`, `MAX_RETRIES`)

---

This architecture follows industry standards and is optimized for a 2-week hackathon MVP!